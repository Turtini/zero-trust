# .github/workflows/build-exports.yml
name: Build PDF Exports

on:
  push:
    branches: [ "main" ]
    paths:
      - "**/*.md"
      - "scripts/**"
      - "styles/**"
      - "diagrams/**"
      - ".github/workflows/build-exports.yml"
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: build-exports-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-exports:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Pandoc + TeX
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pandoc \
            texlive-xetex \
            texlive-latex-extra \
            texlive-fonts-recommended \
            texlive-fonts-extra \
            fonts-croscore \
            fonts-liberation
          fc-list | grep -i arimo | head -n 5 || true

      - name: Build PDF exports
        run: |
          chmod +x scripts/build-export.sh
          ./scripts/build-export.sh

      - name: Commit exports
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Only commit if exports changed
          if [[ -n "$(git status --porcelain exports/)" ]]; then
            git add exports/
            git commit -m "Update PDF exports"
            git pull --rebase
            git push
          else
            echo "No changes in exports/ to commit."
          fi

